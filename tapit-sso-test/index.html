<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Login Example</title>
  <meta content="width=device-width,initial-scale=1" name="viewport">

  <style>
    * {
      margin: 0;
      border: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif
    }

    main {
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-top: 2rem;
      margin-bottom: 4rem;
    }

    p {
      font-size: 1.3rem;
      font-weight: bold;
      text-align: left;
      margin-bottom: 4rem;
    }

    iframe {
      width: 100%;
      height: 20rem;
    }

    @media screen and (min-width: 640px) {
      iframe {
        height: 30rem;
      }
    }
  </style>

  <!-- DO NOT DELETE BECAUSE THIS ENABLES THE PAGE TO HAVE THE USER'S SESSION OPEN IN THE CURRENT DOMAIN-->
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-auth.js"></script>
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBbMDkDVAUJ8MWcKMVtU7Onrzv5JVlfSbA",
      authDomain: "re-imagining-loyalty-dev.firebaseapp.com",
      databaseURL: "https://re-imagining-loyalty-dev.firebaseio.com",
      projectId: "re-imagining-loyalty-dev",
      storageBucket: "re-imagining-loyalty-dev.appspot.com",
      messagingSenderId: "25832745393",
      appId: "1:25832745393:web:d91879ef2d1bf959fcf590",
      measurementId: "G-JMD5T81SQM"
    };

    firebase.initializeApp(FIREBASE_CONFIG);
  </script>
  <!-- DO NOT DELETE BECAUSE THIS ENABLES THE PAGE TO HAVE THE USER'S SESSION OPEN IN THE CURRENT DOMAIN-->
</head>
<body>

<main>
  <h1>LOGIN EXAMPLE WITH <br>TAPIT.COM.CO<br> AS IFRAME</h1>

  <a download="" href="/index.html">Download this example</a>
  
  <p id="userData"></p>
</main>

<script>
  const LOGIN_ORIGIN = 'https://tapit-sso.web.app';
  const LOGIN_PATH = '/app/sso/login';
  const APP_ID = 'app01';

  firebase.auth().onAuthStateChanged(function (userCredential) {
    if (userCredential) {
      document.getElementById('userData').innerText = 'Welcome user ' + userCredential.displayName;
    } else {
      addAuthenticationSystem();
    }
  });

  function addAuthenticationSystem() {
    const loginIframe = createLoginIframe();
    addMessageListener(loginIframe, APP_ID);

    document.querySelector('main').appendChild(loginIframe);
  }

  function createLoginIframe() {
    const loginIframe = document.createElement('iframe');
    loginIframe.setAttribute('src', LOGIN_ORIGIN + LOGIN_PATH)

    loginIframe.addEventListener('load', function () {
      loginIframe.contentWindow.postMessage({
        appId: APP_ID,
        method: 'getUserCustomToken',
        origin: 'aguilapenalties',
        ageGateDate: Date.now()
      }, LOGIN_ORIGIN)
    })

    return loginIframe;
  }

  function addMessageListener(loginIframe) {
    window.addEventListener("message", function (event) {
      if (event.data && event.data.appId === APP_ID) {
        signInWithCustomToken(event.data.customToken, loginIframe)
      } else {
        document.getElementById('userData').innerText = 'Login with facebook to have access to our site';
        loginIframe.setAttribute('style', 'display:block');
      }
    }, false);
  }

  function signInWithCustomToken(customToken, loginIframe) {
    firebase.auth().signInWithCustomToken(customToken)
      .then(function (userCredential) {
        document.getElementById('userData').innerText = 'Welcome user ' + userCredential.displayName;
        loginIframe.parentNode.removeChild(loginIframe);
      })
      .catch(function (error) {
        console.error(error);
      });
  }
</script>
</body>
</html>

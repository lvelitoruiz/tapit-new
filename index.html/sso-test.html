<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Login Example</title>
  <meta content="width=device-width,initial-scale=1" name="viewport">

  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-auth.js"></script>
  <script>
    const TAPIT_ORIGIN = 'http://localhost:4200';

    function setUpCommunication() {
      const tapitIframe = document.getElementById('tapitIframe');

      setTimeout(() => {
        tapitIframe.contentWindow.postMessage({
          channel: 'TAPIT',
          action: 'config',
          config: {
            userEmail: '',
            facebookButton: true,
            offersOption: false,
            passwordInfo: true,
          }
        }, TAPIT_ORIGIN)

        tapitIframe.contentWindow.postMessage({
          channel: 'TAPIT',
          action: 'getUserCustomToken',
          origin: 'aguilapenalties',
          ageGateDate: Date.now()
        }, TAPIT_ORIGIN)
      }, 1000)
    }

    var firebaseConfig = {
      apiKey: "AIzaSyBbMDkDVAUJ8MWcKMVtU7Onrzv5JVlfSbA",
      authDomain: "re-imagining-loyalty-dev.firebaseapp.com",
      databaseURL: "https://re-imagining-loyalty-dev.firebaseio.com",
      projectId: "re-imagining-loyalty-dev",
      storageBucket: "re-imagining-loyalty-dev.appspot.com",
      messagingSenderId: "25832745393",
      appId: "1:25832745393:web:d91879ef2d1bf959fcf590",
      measurementId: "G-JMD5T81SQM"
    };

    firebase.initializeApp(firebaseConfig);

    firebase.auth().onAuthStateChanged(function (userCredential) {
      if (userCredential) {
        document.getElementById('loggedUser').innerText = 'LOGGED_USER: ' + userCredential.email;
      }
    });
  </script>
</head>
<body>

<p id="loggedUser"></p>

<iframe id="tapitIframe" onload="setUpCommunication()" src="http://localhost:4200/sso/login-by-email"
        style="width: 100%; height: 500px"></iframe>

<script>


  function addAuthenticationSystem() {
    const TAPIT_ORIGIN = 'http://localhost:4200';

    const loginIframe = createLoginIframe(TAPIT_ORIGIN);
    addMessageListener(loginIframe);

    document.querySelector('main').appendChild(loginIframe);
  }

  function createLoginIframe(LOGIN_ORIGIN) {
    const loginIframe = document.createElement('iframe');
    loginIframe.setAttribute('src', LOGIN_ORIGIN + '/sso/login')

    loginIframe.addEventListener('load', function () {
      loginIframe.contentWindow.postMessage({
        channel: 'TAPIT',
        action: 'getUserCustomToken',
        origin: 'aguilapenalties',
        ageGateDate: Date.now()
      }, LOGIN_ORIGIN)
    })

    return loginIframe;
  }

  function addMessageListener(loginIframe) {
    window.addEventListener("message", function (event) {
      if (event.data && event.data.channel === 'TAPIT') {
        signInWithCustomToken(event.data.customToken, loginIframe)
      } else {
        document.getElementById('userData').innerText = 'Login with facebook to have access to our site';
        loginIframe.setAttribute('style', 'display:block');
      }
    }, false);
  }

  function signInWithCustomToken(customToken, loginIframe) {
    firebase.auth().signInWithCustomToken(customToken)
      .then(function (userCredential) {
        document.getElementById('userData').innerText = 'Welcome user ' + userCredential.displayName;
        loginIframe.parentNode.removeChild(loginIframe);
      })
      .catch(function (error) {
        console.error(error);
      });
  }
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SSO EXAMPLE</title>
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <link rel="stylesheet" href="https://preview.tapit.com.co/assets/styles/tailwind.css">
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-firestore.js"></script>
  <script src="https://tapit-cdn.web.app/sso-client.js"></script>
  <script src="./tapit.config.local.js"></script>
  <script src="./tapit.config.dev.js"></script>
  <script src="./tapit.config.prev.js"></script>
  <script src="./tapit.config.prod.js"></script>
  <script src="./brahma.config.prod.js"></script>
  <script src="./brahma.config.local.js"></script>

  <script>
    const config = TAPIT_CONFIG_DEV;
    let ssoClient;

    document.addEventListener("DOMContentLoaded", function () {
      ssoClient = new SsoClient(config.clientConfig, config.ssoConfig);
      ssoClient.init();
    });

    /*****************
     Actions
     ********************/
    config.clientConfig.ssoActionListener = function (action, data) {
      switch (action) {
        case 'set-logged-user':
          /* This action is executed when the user credentials were successfully validated,
          it returns in 'data' the information of the user who started the session,
          in this example the data on the iframe is shown and the customToken is obtained
          to be able to login sending it as a parameter of the 'signInWithCustomToken' function*/
          if (data) {
            document.getElementById('iframe-user-data').innerText = JSON.stringify(data);
            document.getElementById('login-popup').classList.add('hidden');
            signInWithCustomToken(data.customToken)
          } else {
            document.getElementById('iframe-user-data').innerText = '';
          }
          break;

        case 'close-popup':
          /* This action is executed when the button to close the popup is clicked,
          in this example the popup is hidden with the 'hidden' attribute */
          document.getElementById('login-popup').classList.add('hidden');
          break;
      }
    }

    /**
     *
     * FIREBASE CONFIGURATION AND USE
     *
     **/

    firebase.initializeApp(config.firebaseConfig);

    /* The recommended way to get the current user is to set an observer on the Auth object */
    firebase.auth().onAuthStateChanged(function (userCredential) {
      if (userCredential) {
        /* Get user data */
        firebase.firestore().collection('user_account_tap').doc(userCredential.uid).get()
          .then(function (documentSnapshot) {
            document.getElementById('firebase-user-data').innerText = JSON.stringify(documentSnapshotToObject(documentSnapshot));
          })
          .catch(function (error) {
            console.error(error);
          });
      }
    });

    function signInWithCustomToken(customToken) {
      firebase.auth().signInWithCustomToken(customToken)
        .then(userCredential => {
          /* Next steps after login */
        })
        .catch(function (error) {
          console.error(error);
        });
    }

    function documentSnapshotToObject(documentSnapshot) {
      const object = documentSnapshot.data() || {};
      object.id = documentSnapshot.id;

      for (const objectKey in object) {
        if (object.hasOwnProperty(objectKey)) {
          if (object[objectKey] instanceof firebase.firestore.Timestamp) {
            object[objectKey] = object[objectKey].toDate()
          }

          if (object[objectKey] instanceof firebase.firestore.DocumentReference) {
            object[objectKey] = object[objectKey].id;
          }
        }
      }

      return object;
    }

    function showSSOPopup(path) {
      const loginElement = document.getElementById('login-popup');
      ssoClient.ssoExecuteAction('navigateTo', path);
      loginElement.classList.remove('hidden');
    }

    function logout() {
      ssoClient.ssoExecuteAction('logout');
      firebase.auth().signOut().then(function () {
        document.getElementById('firebase-user-data').innerText = '';
      });
    }
  </script>
</head>


<body>
<div class="text-center my-32" id="login-button">
  <button class="app-button bg-primary-500 text-white" onclick="showSSOPopup('/login')">INICIAR SESIÓN</button>
  <button class="app-button bg-secondary-500 text-white" onclick="showSSOPopup('/sign-up')">REGISTRARSE</button>
  <button class="app-button bg-danger-500 text-white" onclick="logout()">CERRAR SESIÓN</button>
</div>

<div class="m-4 rounded-lg bg-neutral-200 p-4">
  <h1 class="font-bold">IFRAME LOGGED USER</h1>
  <p id="iframe-user-data" class=" overflow-x-auto"></p>
</div>

<div class="m-4 rounded-lg bg-neutral-200 p-4">
  <h1 class="font-bold">LOCAL LOGGED USER</h1>
  <p id="firebase-user-data" class=" overflow-x-auto"></p>
</div>

<div class="m-4 mt-20 rounded-lg p-4">
  <a href="/index.html" download>Download source code here!</a>
  <a href="/docs.html" target="_blank">See the docs here!</a>
</div>

<div id="login-popup" class="hidden mx-auto max-w-md">
  <div class="fixed bottom-0 inset-x-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
    <div class="fixed inset-0 transition-opacity">
      <div class="absolute inset-0 bg-neutral-500 opacity-75"></div>
    </div>

    <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full"
         role="dialog" aria-modal="true" aria-labelledby="modal-headline">
      <iframe class="w-full max-h-screen" id="sso-iframe" src="" style="height: 773px"></iframe>
    </div>
  </div>
</div>
</body>
</html>
